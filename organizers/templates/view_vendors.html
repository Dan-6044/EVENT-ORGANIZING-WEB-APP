{% extends 'master.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dash.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">


<!-- ðŸ”¹ Top Navbar -->
<nav class="navbar px-3  fixed-top  shadow">
    <h2 class="text-white">EOS</h2>
    <span class="navbar-brand">EOS ORGANIZERS PANEL</span>
    <div class="d-flex align-items-center">
        <div class="dropdown">
            <button class="btn p-0 border-0 rounded-circle" type="button" data-bs-toggle="dropdown">
                <img src="{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" 
                    alt="Profile" 
                     class="rounded-circle border border-secondary" 
                     width="35" height="35">
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg p-3" style="width: 340px; left: auto; right: 0;">
                <li><a class="dropdown-item text-start" href="#">My Profile</a></li>
                <li><a class="dropdown-item text-start" href="#">My Account</a></li>
                <hr class="mx-auto" style="width: 90%;">
                <a href="{% url 'logout' %}" class="btn btn-primary text-danger" style="width: 90%;">Logout</a>
            </ul>
        </div>
    </div>
</nav>


<div class="d-flex">
    <nav class="sidebar  text-dark  p-3">
        <h4 class="text-center head ">EOS PANEL</h4>
        
        <!-- Dashboard Section -->
        <h6 class="text-uppercase mt-3 text-white">Dashboard</h6>
        <ul class="nav flex-column">
            <li class="nav-item my-1 {% if request.path == '/dashboard/' %}active{% endif %}">
                <a class="nav-link d-flex align-items-center" href="{% url 'dashboard' %}">
                    <i class="fas fa-home me-2"></i> Home
                </a>
            </li>
            
            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#eventsMenu">
                    <span><i class="fas fa-microphone-alt"></i> Events</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_event/' or request.path == '/view_events/' %}show{% endif %}" id="eventsMenu">
                    <a href="{% url 'view_events' %}" class="nav-link ms-3 text-white {% if request.path == '/view_events/' %}active{% endif %}">View Events</a>
                    <a href="{% url 'add_event' %}" class="nav-link ms-3 text-white {% if request.path == '/add_event/' %}active{% endif %}">Add Event</a>
                </div>
            </li>         
             
            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#vendorsMenu">
                    <span><i class="fas fa-truck"></i> Vendors</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_vendor/' or request.path == '/view_vendors/' %}show{% endif %}" id="vendorsMenu">
                    <a href="{% url 'view_vendors' %}" class="nav-link ms-3 text-white {% if request.path == '/view_vendors/' %}active{% endif %}">View Vendors</a>
                    <a href="{% url 'add_vendor' %}" class="nav-link ms-3 text-white {% if request.path == '/add_vendor/' %}active{% endif %}">Add Vendor</a>
                </div>
            </li>
            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#ticketsMenu">
                    <span><i class="fas fa-ticket-alt"></i> Tickets</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_ticket/' or request.path == '/view_tickets/' %}show{% endif %}" id="ticketsMenu">
                    <a href="{% url 'view_tickets' %}" class="nav-link ms-3 text-white {% if request.path == '/view_tickets/' %}active{% endif %}">View Tickets</a>
                    <a href="{% url 'add_ticket' %}" class="nav-link ms-3 text-white {% if request.path == '/add_ticket/' %}active{% endif %}">Add Ticket</a>
                </div>
            </li>  

            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#schedulesMenu">
                    <span><i class="fas fa-calendar-check"></i> Schedule</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_schedule/' or request.path == '/view_schedules/' %}show{% endif %}" id="schedulesMenu">
                    <a href="{% url 'view_schedules' %}" class="nav-link ms-3 text-white {% if request.path == '/view_schedules/' %}active{% endif %}">View Schedules</a>
                    <a href="{% url 'add_schedule' %}" class="nav-link ms-3 text-white {% if request.path == '/add_schedule/' %}active{% endif %}">Add Schedule</a>
                </div>
            </li>           
            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#sponsorsMenu">
                    <span><i class="fas fa-chart-bar"></i> Sponsor</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_sponsor/' or request.path == '/view_sponsors/' %}show{% endif %}" id="sponsorsMenu">
                    <a href="{% url 'view_sponsors' %}" class="nav-link ms-3 text-white {% if request.path == '/view_sponsors/' %}active{% endif %}">View Sponsors</a>
                    <a href="{% url 'add_sponsor' %}" class="nav-link ms-3 text-white {% if request.path == '/add_sponsor/' %}active{% endif %}">Add Sponsor</a>
                </div>
            </li>     

            <li class="nav-item my-1">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#attendeesMenu">
                    <span><i class="fas fa-theater-masks"></i> Event Attendee</span> 
                    <i class="fas fa-chevron-right rotate-icon"></i>
                </a>
                <div class="collapse {% if request.path == '/add_attendee/' or request.path == '/view_attendees/' %}show{% endif %}" id="attendeesMenu">
                    <a href="{% url 'view_attendees' %}" class="nav-link ms-3 text-white {% if request.path == '/view_attendees/' %}active{% endif %}">View Attendees</a>
                    <a href="{% url 'add_attendee' %}" class="nav-link ms-3 text-white {% if request.path == '/add_attendee/' %}active{% endif %}">Add Attendee</a>
                </div>
            </li> 

             <li class="nav-item my-1 {% if request.path == '/reports/' %}active{% endif %}">
                <a class="nav-link d-flex align-items-center" href="{% url 'reports' %}">
                    <i class="fas fa-bell me-2"></i> Reports
                </a>
            </li>                 
        
        </ul>

        <!-- Account Options Section -->
        <h6 class="text-uppercase mt-4 text-white">Account Options</h6>
        <ul class="nav flex-column">
            <li class="nav-item my-1">
                <a class="nav-link text-white" href="#profile"> <i class="fas fa-user"></i> Profile Settings</a>
            </li>
            <li class="nav-item my-1">
                <a class="nav-link text-danger" href="{% url 'logout' %}"> <i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </ul>
    </nav>


    <div class="content flex-grow-1 p-4">
            <div class="d-flex justify-content-center">
                <div class="col-md-6"> <!-- Increased width and centered -->
                    <div class="card shadow-lg border-0 rounded-3">
                        <div class="card-body text-center py-3">
                            <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                            <h6 class="card-title fw-bold mb-2">Select Event</h6>
                            <select id="eventDropdown" class="form-select">
                                <option value="">-- Select Event --</option>
                                {% for event in events %}
                                <option value="{{ event.id }}">{{ event.event_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
    
    <!-- Vendor DataTable -->
    <div class="card mt-3">
        <div class="card-header bg-light py-2">
            <i class="fas fa-table me-1"></i> Vendors for Selected Event
        </div>
        <div class="card-body p-2">
            <div class="table-responsive">
                <table id="vendorTable" class="table table-striped table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Vendor Name</th>
                            <th class="text-center">Vendor Type</th>
                            <th class="text-center">Description</th>
                            <th class="text-center">Agreed Payment Cost</th>
                            <th class="text-center">Deposits</th>
                            <th class="text-center">Credit Days</th>
                            <th class="text-center">Payment Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Vendor data will be inserted dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</div>


<!-- Edit Vendor Modal -->
<div class="modal fade" id="editVendorModal" tabindex="-1" aria-labelledby="editVendorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title mx-auto text-info" id="editEventModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVendorForm">
                    <input type="hidden" id="edit_vendor_id" name="vendor_id">

                     <div class="row">
                            <div class="col-md-6 form-group">
                            <label for="edit_vendor_name" class="form-label">Vendor Name</label>
                            <input type="text" class="form-control" id="edit_vendor_name" name="vendor_name" required>
                        </div>
                        <div class="col-md-6 form-group">
                            <label for="edit_vendor_type" class="form-label">Vendor Type</label>
                            <select class="form-control" id="edit_vendor_type" name="vendor_type" required>
                                <option value="">Select Vendor</option>
                                <option value="venue">Venue</option>
                                <option value="catering">Catering</option>
                                <option value="av">Audio Visual</option>
                                <option value="decor">Decor</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="security">Security</option>
                                <option value="printing">Printing</option>
                                <option value="transportation">Transportation</option>
                                <option value="waste_management">Waste Management</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_vendor_description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit_vendor_description" name="vendor_description" rows="3" required></textarea>
                        </div>
                    
                    <!-- Vendor-specific fields -->
                    <div id="venue_section" class="vendor-specific" style="display: none;">
                       <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="edit_venue_address" class="form-label">Venue Address</label>
                               <input type="text" class="form-control" id="edit_venue_address" name="edit_venue_address">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="venue_capacity" class="form-label">Venue Capacity</label>
                               <input type="number" class="form-control" id="venue_capacity" name="venue_capacity">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 form-group">
                               <label for="venue_booking_time" class="form-label">Venue Booking Time</label>
                            <input type="datetime-local" class="form-control" id="venue_booking_time" name="venue_booking_time">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="venue_requirements" class="form-label">Venue Requirements</label>
                               <input type="text" class="form-control" id="venue_requirements" name="venue_requirements">
                            </div>
                        </div>  
                        <div class="row">
                            <div class="col-md-6 form-group">
                               <label for="venue_rental_cost" class="form-label">Rental Cost</label>
                            <input type="number" class="form-control" id="venue_rental_cost" name="venue_rental_cost">
                            </div>
                        </div>                      
                    </div>

                    <div id="catering_section" class="vendor-specific" style="display: none;">
                    <div class="row">
                            <div class="col-md-6 form-group">
                               <label for="catering_type" class="form-label">Catering Type</label>
                              <input type="text" class="form-control" id="catering_type" name="catering_type">
                            </div>
                            <div class="col-md-6 form-group">
                               <label for="menu_options" class="form-label">Menu Options</label>
                            <textarea class="form-control" id="menu_options" name="menu_options"></textarea>
                            </div>
                        </div> 
                         <div class="mb-3">
                            <label for="catering_cost" class="form-label">Catering Cost</label>
                            <input type="number" class="form-control" id="catering_cost" name="catering_cost">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" id="saveVendorChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const vendorTypeSelect = document.getElementById("edit_vendor_type");
        const venueSection = document.getElementById("venue_section");
        const cateringSection = document.getElementById("catering_section");

        function toggleVendorFields() {
            venueSection.style.display = "none";
            cateringSection.style.display = "none";

            if (vendorTypeSelect.value === "venue") {
                venueSection.style.display = "block";
            } else if (vendorTypeSelect.value === "catering") {
                cateringSection.style.display = "block";
            }
        }

        // Trigger field display on select change
        vendorTypeSelect.addEventListener("change", toggleVendorFields);

        // Event listener for edit buttons
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("edit-vendor-btn")) {
                const vendorId = event.target.getAttribute("data-vendor-id");
                const vendorName = event.target.getAttribute("data-vendor-name");
                const vendorType = event.target.getAttribute("data-vendor-type");
                const vendorDescription = event.target.getAttribute("data-vendor-description");

                // Vendor-specific fields
                const venueAddress = event.target.getAttribute("data-venue-address");
                const venueCapacity = event.target.getAttribute("data-venue-capacity");
                const venueRentalCost = event.target.getAttribute("data-venue-rental-cost");
                const venueBookingTime = event.target.getAttribute("data-venue-booking-time");
                const venueRequirements = event.target.getAttribute("data-venue-requirements");

                const cateringType = event.target.getAttribute("data-catering-type");
                const menuOptions = event.target.getAttribute("data-menu-options");
                const dietaryPreferences = event.target.getAttribute("data-dietary-preferences");
                const cateringCost = event.target.getAttribute("data-catering-cost");
                const serviceRequirements = event.target.getAttribute("data-service-requirements");

                const equipmentProvided = event.target.getAttribute("data-equipment-provided");
                const avCost = event.target.getAttribute("data-av-cost");
                const technicalSupport = event.target.getAttribute("data-technical-support");
                const setupTime = event.target.getAttribute("data-setup-time");
                const contactEmergency = event.target.getAttribute("data-contact-emergency");

                const designTheme = event.target.getAttribute("data-design-theme");
                const itemsSupplied = event.target.getAttribute("data-items-supplied");
                const decorCost = event.target.getAttribute("data-decor-cost");
                const returnTearDownTime = event.target.getAttribute("data-return-tear-down-time");

                const typeOfEntertainment = event.target.getAttribute("data-type-of-entertainment");
                const entertainmentCost = event.target.getAttribute("data-entertainment-cost");
                const performanceDuration = event.target.getAttribute("data-performance-duration");
                const specialRequirements = event.target.getAttribute("data-special-requirements");

                const securityPersonnelCount = event.target.getAttribute("data-security-personnel-count");
                const securityDuties = event.target.getAttribute("data-security-duties");
                const securityCost = event.target.getAttribute("data-security-cost");
                const setupRequirements = event.target.getAttribute("data-setup-requirements");

                const printedMaterials = event.target.getAttribute("data-printed-materials");
                const printingCost = event.target.getAttribute("data-printing-cost");
                const designRequirements = event.target.getAttribute("data-design-requirements");
                const deliveryTimeframe = event.target.getAttribute("data-delivery-timeframe");

                const transportType = event.target.getAttribute("data-transport-type");
                const transportationCost = event.target.getAttribute("data-transportation-cost");
                const transportSchedule = event.target.getAttribute("data-transport-schedule");
                const passengerCapacity = event.target.getAttribute("data-passenger-capacity");
                const specialRequests = event.target.getAttribute("data-special-requests");

                const wasteTypesCollected = event.target.getAttribute("data-waste-types-collected");
                const wasteManagementCost = event.target.getAttribute("data-waste-management-cost");
                const serviceDetails = event.target.getAttribute("data-service-details");
                const restroomFacilities = event.target.getAttribute("data-restroom-facilities");

                // Populate modal fields
                document.getElementById("edit_vendor_id").value = vendorId;
                document.getElementById("edit_vendor_name").value = vendorName;
                document.getElementById("edit_vendor_type").value = vendorType;
                document.getElementById("edit_vendor_description").value = vendorDescription;

                // Populate vendor-specific fields
                document.getElementById("edit_venue_address").value = venueAddress || "";
                document.getElementById("venue_capacity").value = venueCapacity || "";
                document.getElementById("venue_rental_cost").value = venueRentalCost || "";
                document.getElementById("venue_booking_time").value = venueBookingTime || "";
                document.getElementById("venue_requirements").value = venueRequirements || "";

                document.getElementById("catering_type").value = cateringType || "";
                document.getElementById("menu_options").value = menuOptions || "";
                document.getElementById("catering_cost").value = cateringCost || "";

                // Show the correct vendor fields
                toggleVendorFields();

                // Show the modal
                let modal = new bootstrap.Modal(document.getElementById("editVendorModal"));
                modal.show();
            }
        });

        // Handle Save Changes Button Click
        document.getElementById("saveVendorChanges").addEventListener("click", function () {
            const formData = new FormData(document.getElementById("editVendorForm"));

            fetch('/update_vendor/', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert("Vendor details updated successfully!");
                      location.reload();
                  } else {
                      alert("Error updating vendor details.");
                  }
              });
        });

    });
</script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    $("#eventDropdown").change(function () {
        let eventId = $(this).val(); // Get selected event ID
        if (eventId) {
            $.ajax({
                url: `/get-vendors/${eventId}/`, // Fetch vendors for the selected event
                type: "GET",
                dataType: "json",
                success: function (response) {
                    let tableBody = $("#vendorTable tbody");
                    tableBody.empty(); // Clear previous vendors

                    if (response.vendors.length > 0) {
                        response.vendors.forEach(vendor => {
                            let row = `<tr>
                                <td class="text-center">${vendor.name}</td>
                                <td class="text-center">${vendor.vendor_type}</td>
                                <td class="text-center">${vendor.description}</td>
                                <td class="text-center">${vendor.payment_cost}</td>
                                <td class="text-center">${vendor.deposit}</td>
                                <td class="text-center">${vendor.credit_days}</td>
                                <td class="text-center">${vendor.payment_status}</td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm edit-vendor-btn"
                    data-vendor-id="${vendor.vendor_id}"
                    data-vendor-name="${vendor.name}"
                    data-vendor-type="${vendor.vendor_type}"
                    data-vendor-description="${vendor.description}"
                    data-vendor-payment_cost="${vendor.payment_cost}"
                    data-vendor-deposit="${vendor.deposit}"
                    data-vendor-credit_days="${vendor.credit_days}"
                    data-vendor-payment_status="${vendor.payment_status}"
                    
                    ${vendor.vendor_type === "venue" ? `
                         data-venue-address="${vendor.venue_address || ''}"
                        data-venue-capacity="${vendor.venue_capacity || ''}"
                        data-venue-rental-cost="${vendor.venue_rental_cost || ''}"
                        data-venue-requirements="${vendor.venue_requirements || ''}"
                        data-venue-booking-time="${vendor.venue_booking_time || ''}"
                    ` : ""}
                    
                    ${vendor.vendor_type === "catering" ? `
                        data-catering-type="${vendor.catering_type}"
                        data-menu-options="${vendor.menu_options}"
                        data-catering-cost="${vendor.catering_cost}"
                    ` : ""}
                >
                    Edit
                </button>
                                    <a href="/delete_vendor/${vendor.vendor_id}/" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete this vendor?');">
                                        Delete
                                    </a>
                                </td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        tableBody.append('<tr><td colspan="8" class="text-center">No vendors found for this event.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    alert("Error fetching vendors: " + xhr.responseJSON.error);
                }
            });
        } else {
            $("#vendorTable tbody").empty(); // Clear table if no event is selected
        }
    });
});
</script>
<script>
    // Script to rotate chevron icons on collapse toggle
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(item => {
        item.addEventListener('click', function () {
            let icon = this.querySelector('.rotate-icon');
            if (icon) {
                icon.classList.toggle('rotate-down');
            }
        });
    });
</script>
<!-- Include jQuery, DataTables & Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Initialize DataTable -->
<script>
    $(document).ready(function() {
        $('#datatablesSimple').DataTable({
             "stateSave": true,
            "paging": true,
            "lengthMenu": [5, 10, 25, 50], // Show entries per page
            "ordering": true, // Enable sorting on all columns
            "info": true, // Footer info (e.g., Showing 1 to 10 of 50 entries)
            "searching": true, // Enable search box
            "language": {
                "emptyTable": ""
                "lengthMenu": " _MENU_ Show entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                "paginate": {
                    "previous": "Previous",
                    "next": "Next"
                }
            }
        });
    });
</script>


{% endblock %}
